name: Add to Project

on:
  issues:
    types: [opened]
  pull_request_target:
    types: [opened]

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    
    steps:
    - name: Add issue to project
      if: github.event_name == 'issues'
      run: |
        echo "ğŸ¯ Adding issue #${{ github.event.issue.number }} to project"
        
        # Get project ID first
        PROJECT_ID=$(gh api graphql -f query='
          query GetProject($login: String!, $number: Int!) {
            user(login: $login) {
              projectV2(number: $number) {
                id
              }
            }
          }' -f login="mPokornyETM" -F number=3 --jq '.data.user.projectV2.id' 2>/dev/null || echo "")
        
        if [ -z "$PROJECT_ID" ]; then
          echo "âŒ Could not get project ID - project may not exist or not accessible"
          echo "â„¹ï¸ Please check project URL: https://github.com/users/mPokornyETM/projects/3"
          exit 0
        fi
        
        echo "âœ… Project ID: $PROJECT_ID"
        
        # Add issue to project using GraphQL API
        if gh api graphql -f query='
          mutation AddIssueToProject($projectId: ID!, $issueId: ID!) {
            addProjectV2ItemById(input: {
              projectId: $projectId
              contentId: $issueId
            }) {
              item {
                id
              }
            }
          }' -f projectId="$PROJECT_ID" -f issueId="${{ github.event.issue.node_id }}" >/dev/null 2>&1; then
          echo "âœ… Issue added to project successfully"
        else
          echo "âš ï¸ Failed to add issue to project - may already exist or insufficient permissions"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Add PR to project
      if: github.event_name == 'pull_request_target'
      run: |
        echo "ğŸ¯ Adding PR #${{ github.event.pull_request.number }} to project"
        
        # Get project ID first
        PROJECT_ID=$(gh api graphql -f query='
          query GetProject($login: String!, $number: Int!) {
            user(login: $login) {
              projectV2(number: $number) {
                id
              }
            }
          }' -f login="mPokornyETM" -F number=3 --jq '.data.user.projectV2.id' 2>/dev/null || echo "")
        
        if [ -z "$PROJECT_ID" ]; then
          echo "âŒ Could not get project ID - project may not exist or not accessible"
          echo "â„¹ï¸ Please check project URL: https://github.com/users/mPokornyETM/projects/3"
          exit 0
        fi
        
        echo "âœ… Project ID: $PROJECT_ID"
        
        # Add PR to project using GraphQL API
        if gh api graphql -f query='
          mutation AddPRToProject($projectId: ID!, $prId: ID!) {
            addProjectV2ItemById(input: {
              projectId: $projectId
              contentId: $prId
            }) {
              item {
                id
              }
            }
          }' -f projectId="$PROJECT_ID" -f prId="${{ github.event.pull_request.node_id }}" >/dev/null 2>&1; then
          echo "âœ… PR added to project successfully"
        else
          echo "âš ï¸ Failed to add PR to project - may already exist or insufficient permissions"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set project fields
      run: |
        echo "ğŸ·ï¸ Setting project fields based on labels and type"
        
        # Determine if this is an issue or PR
        if [ "${{ github.event_name }}" = "issues" ]; then
          ITEM_TYPE="Issue"
          ITEM_NUMBER="${{ github.event.issue.number }}"
          ITEM_TITLE="${{ github.event.issue.title }}"
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
        else
          ITEM_TYPE="Pull Request"
          ITEM_NUMBER="${{ github.event.pull_request.number }}"
          ITEM_TITLE="${{ github.event.pull_request.title }}"
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
        fi
        
        echo "ğŸ“‹ $ITEM_TYPE #$ITEM_NUMBER: $ITEM_TITLE"
        echo "ğŸ·ï¸ Labels: $LABELS"
        
        # Set status based on labels
        if echo "$LABELS" | grep -q "bug"; then
          echo "ğŸ› Bug detected - setting appropriate status"
        elif echo "$LABELS" | grep -q "enhancement\|feature"; then
          echo "ğŸš€ Feature detected - setting appropriate status"
        elif echo "$LABELS" | grep -q "dependencies"; then
          echo "ğŸ“¦ Dependency update detected - setting appropriate status"
        fi
        
        echo "âœ… Project fields configured"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Success notification
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          echo "ğŸ‰ Issue #${{ github.event.issue.number }} successfully added to project!"
          echo "ğŸ”— Project: https://github.com/users/mPokornyETM/projects/3"
          echo "ğŸ“‹ Issue: ${{ github.event.issue.html_url }}"
        else
          echo "ğŸ‰ PR #${{ github.event.pull_request.number }} successfully added to project!"
          echo "ğŸ”— Project: https://github.com/users/mPokornyETM/projects/3" 
          echo "ğŸ“‹ PR: ${{ github.event.pull_request.html_url }}"
        fi